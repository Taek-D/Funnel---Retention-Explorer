{
    "name": "Analytics Report Email",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "analytics-report",
                "responseMode": "onReceived",
                "options": {}
            },
            "id": "webhook-node",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                240,
                300
            ]
        },
        {
            "parameters": {
                "mode": "runOnceForAllItems",
                "jsCode": "// Get webhook data\nconst body = $input.first().json.body;\n\n// Test request\nif (body.test === true) {\n  return [{\n    json: {\n      success: true,\n      message: 'í…ŒìŠ¤íŠ¸ ì„±ê³µ',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\n// Extract data\nconst reportData = body.reportData || {};\nconst dataQuality = reportData.dataQuality || {};\nconst insights = reportData.insights || [];\nconst attachments = body.attachments || [];\n\n// Generate HTML email\nconst emailBody = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    h2 { color: #4f46e5; border-bottom: 2px solid #4f46e5; padding-bottom: 10px; }\n    h3 { color: #6366f1; margin-top: 20px; }\n    .metric { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 10px 0; }\n    .metric-label { font-weight: bold; color: #6b7280; }\n    .metric-value { font-size: 1.2em; color: #111827; }\n    .insight { background: #fef3c7; padding: 12px; border-left: 4px solid #f59e0b; margin: 10px 0; border-radius: 4px; }\n    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.9em; }\n  </style>\n</head>\n<body>\n  <h2>ğŸ“Š ë°ì´í„° ë¶„ì„ ë¦¬í¬íŠ¸</h2>\n  <p><strong>ìƒì„± ì‹œê°„:</strong> ${reportData.generatedAt || 'N/A'}</p>\n  <h3>ğŸ“ˆ ë°ì´í„° ìš”ì•½</h3>\n  <div class=\"metric\">\n    <div><span class=\"metric-label\">ì´ í–‰ìˆ˜:</span> <span class=\"metric-value\">${(dataQuality.totalRows || 0).toLocaleString()}</span></div>\n    <div><span class=\"metric-label\">ìœ íš¨ í–‰ìˆ˜:</span> <span class=\"metric-value\">${(dataQuality.validRows || 0).toLocaleString()}</span></div>\n    <div><span class=\"metric-label\">ê³ ìœ  ì‚¬ìš©ì:</span> <span class=\"metric-value\">${(dataQuality.uniqueUsers || 0).toLocaleString()}</span></div>\n    <div><span class=\"metric-label\">ë¶„ì„ ê¸°ê°„:</span> <span class=\"metric-value\">${dataQuality.dateMin || 'N/A'} ~ ${dataQuality.dateMax || 'N/A'}</span></div>\n  </div>\n  <h3>ğŸ’¡ ì£¼ìš” ì¸ì‚¬ì´íŠ¸</h3>\n  ${insights.slice(0, 5).map(i => `\n    <div class=\"insight\">\n      <strong>${i.title || 'Insight'}</strong>\n      ${i.metric ? `<br><em>ì§€í‘œ: ${i.metric}</em>` : ''}\n      <p>${i.body || ''}</p>\n    </div>\n  `).join('')}\n  <div class=\"footer\">\n    <p><strong>ğŸ“ ì²¨ë¶€ íŒŒì¼:</strong> ${attachments.length}ê°œì˜ ìƒì„¸ ë¶„ì„ ì°¨íŠ¸ê°€ ì²¨ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>\n    <p>ë³¸ ë¦¬í¬íŠ¸ëŠ” Funnel & Retention Explorerì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>\n  </div>\n</body>\n</html>\n`;\n\n// Build output items array with binary data for each attachment\nconst outputItems = [];\n\n// Create main item with email data\nconst mainItem = {\n  json: {\n    to: Array.isArray(body.emailTo) ? body.emailTo.join(', ') : body.emailTo,\n    subject: body.subject || 'ë°ì´í„° ë¶„ì„ ë¦¬í¬íŠ¸',\n    html: emailBody,\n    attachmentCount: attachments.length\n  },\n  binary: {}\n};\n\n// Add each attachment as binary data\nfor (let i = 0; i < attachments.length; i++) {\n  const att = attachments[i];\n  mainItem.binary[`attachment_${i}`] = {\n    data: att.content,\n    mimeType: att.mimeType || 'image/png',\n    fileName: att.filename,\n    fileExtension: 'png'\n  };\n}\n\noutputItems.push(mainItem);\n\nreturn outputItems;"
            },
            "id": "code-node",
            "name": "Process Report",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                460,
                300
            ]
        },
        {
            "parameters": {
                "fromEmail": "noreply@yourcompany.com",
                "toEmail": "={{ $json.to }}",
                "subject": "={{ $json.subject }}",
                "emailType": "html",
                "message": "={{ $json.html }}",
                "options": {
                    "attachments": "={{ Object.keys($binary).join(',') }}"
                }
            },
            "id": "email-node",
            "name": "Send Email",
            "type": "n8n-nodes-base.emailSend",
            "typeVersion": 2.1,
            "position": [
                680,
                300
            ],
            "credentials": {
                "smtp": {
                    "id": "1",
                    "name": "SMTP account"
                }
            }
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Process Report",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process Report": {
            "main": [
                [
                    {
                        "node": "Send Email",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1"
    },
    "id": "analytics-report"
}