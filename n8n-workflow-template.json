{
  "name": "Analytics Report Email Sender",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "analytics-report",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-node",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "analytics-report"
    },
    {
      "parameters": {
        "functionCode": "const body = $input.item.json;\n\n// í…ŒìŠ¤íŠ¸ ìš”ì²­ ì²˜ë¦¬\nif (body.test === true) {\n  return {\n    json: {\n      success: true,\n      message: 'í…ŒìŠ¤íŠ¸ ì„±ê³µ',\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n\n// ì‹¤ì œ ë¦¬í¬íŠ¸ ë°ì´í„° ì²˜ë¦¬\nconst reportData = body.reportData || {};\nconst dataQuality = reportData.dataQuality || {};\nconst insights = reportData.insights || [];\n\n// ì´ë©”ì¼ ë³¸ë¬¸ HTML ìƒì„±\nconst emailBody = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    h2 { color: #4f46e5; border-bottom: 2px solid #4f46e5; padding-bottom: 10px; }\n    h3 { color: #6366f1; margin-top: 20px; }\n    ul { list-style-type: none; padding-left: 0; }\n    li { padding: 8px 0; border-bottom: 1px solid #e5e7eb; }\n    .metric { background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 10px 0; }\n    .metric-label { font-weight: bold; color: #6b7280; }\n    .metric-value { font-size: 1.2em; color: #111827; }\n    .insight { background: #fef3c7; padding: 12px; border-left: 4px solid #f59e0b; margin: 10px 0; border-radius: 4px; }\n    .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.9em; }\n  </style>\n</head>\n<body>\n  <h2>ğŸ“Š ë°ì´í„° ë¶„ì„ ë¦¬í¬íŠ¸</h2>\n  <p><strong>ìƒì„± ì‹œê°„:</strong> ${reportData.generatedAt || 'N/A'}</p>\n  \n  <h3>ğŸ“ˆ ë°ì´í„° ìš”ì•½</h3>\n  <div class=\"metric\">\n    <div><span class=\"metric-label\">ì´ í–‰ìˆ˜:</span> <span class=\"metric-value\">${dataQuality.totalRows?.toLocaleString() || 'N/A'}</span></div>\n    <div><span class=\"metric-label\">ìœ íš¨ í–‰ìˆ˜:</span> <span class=\"metric-value\">${dataQuality.validRows?.toLocaleString() || 'N/A'}</span></div>\n    <div><span class=\"metric-label\">ê³ ìœ  ì‚¬ìš©ì:</span> <span class=\"metric-value\">${dataQuality.uniqueUsers?.toLocaleString() || 'N/A'}</span></div>\n    <div><span class=\"metric-label\">ë¶„ì„ ê¸°ê°„:</span> <span class=\"metric-value\">${dataQuality.dateMin || 'N/A'} ~ ${dataQuality.dateMax || 'N/A'}</span></div>\n  </div>\n  \n  <h3>ğŸ’¡ ì£¼ìš” ì¸ì‚¬ì´íŠ¸</h3>\n  ${insights.slice(0, 5).map(insight => `\n    <div class=\"insight\">\n      <strong>${insight.title || 'Insight'}</strong>\n      ${insight.metric ? `<br><em>ì§€í‘œ: ${insight.metric}</em>` : ''}\n      <p>${insight.body || ''}</p>\n      ${insight.action ? `<p><strong>ê¶Œì¥ ì¡°ì¹˜:</strong> ${insight.action}</p>` : ''}\n    </div>\n  `).join('')}\n  \n  <div class=\"footer\">\n    <p><strong>ğŸ“ ì²¨ë¶€ íŒŒì¼:</strong> ${body.pageCount || 0}ê°œì˜ ìƒì„¸ ë¶„ì„ ì°¨íŠ¸ PNG ì´ë¯¸ì§€</p>\n    <p><em>ì²¨ë¶€ëœ ì´ë¯¸ì§€ì—ì„œ ì „ì²´ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>\n    <p>ë³¸ ë¦¬í¬íŠ¸ëŠ” Funnel & Retention Explorerì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>\n  </div>\n</body>\n</html>\n`;\n\n// ë‹¤ìŒ ë…¸ë“œë¡œ ì „ë‹¬í•  ë°ì´í„°\nreturn {\n  json: {\n    emailTo: body.emailTo,\n    subject: body.subject,\n    htmlBody: emailBody,\n    attachments: body.attachments || [],\n    pageCount: body.pageCount || 0\n  }\n};"
      },
      "id": "parse-data-node",
      "name": "Parse Report Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "functionCode": "const attachments = $json.attachments || [];\n\n// base64ë¥¼ binaryë¡œ ë³€í™˜\nfor (const att of attachments) {\n  const binaryData = Buffer.from(att.content, 'base64');\n  \n  $binary[att.filename] = {\n    data: binaryData.toString('base64'),\n    mimeType: att.mimeType || 'image/png',\n    fileName: att.filename,\n    fileExtension: 'png'\n  };\n}\n\nreturn {\n  json: $json,\n  binary: $binary\n};"
      },
      "id": "convert-binary-node",
      "name": "Convert to Binary",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "fromEmail": "noreply@yourcompany.com",
        "toEmail": "={{ $json.emailTo.join(\", \") }}",
        "subject": "={{ $json.subject }}",
        "emailType": "html",
        "message": "={{ $json.htmlBody }}",
        "options": {
          "attachments": "={{ $json.attachments.map(att => att.filename).join(\",\") }}"
        }
      },
      "id": "email-node",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [900, 300],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Report Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Report Data": {
      "main": [
        [
          {
            "node": "Convert to Binary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to Binary": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "id": "analytics-report-email",
  "meta": {
    "instanceId": "your-instance-id"
  },
  "tags": []
}
