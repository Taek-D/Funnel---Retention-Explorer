<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funnel & Retention Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">📊 퍼널 & 리텐션 분석</h1>
                <p class="app-subtitle">고급 분석 대시보드</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tab-navigation">
            <button class="tab-btn active" data-screen="upload">
                <span class="tab-icon">📤</span>
                <span class="tab-label">데이터 업로드</span>
            </button>
            <button class="tab-btn" data-screen="funnel">
                <span class="tab-icon">🔽</span>
                <span class="tab-label">퍼널 분석</span>
            </button>
            <button class="tab-btn" data-screen="retention">
                <span class="tab-icon">📈</span>
                <span class="tab-label">리텐션 코호트</span>
            </button>
            <button class="tab-btn" data-screen="segment">
                <span class="tab-icon">🔍</span>
                <span class="tab-label">세그먼트 비교</span>
            </button>
            <button class="tab-btn" data-screen="insights">
                <span class="tab-icon">💡</span>
                <span class="tab-label">인사이트 카드</span>
            </button>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Screen 1: Upload & Mapping -->
            <div id="screen-upload" class="screen active">
                <div class="screen-header">
                    <h2>데이터 업로드 및 컬럼 매핑</h2>
                    <p>CSV 파일을 업로드하고 필요한 컬럼을 매핑하세요</p>
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📁</div>
                        <h3>CSV 파일을 여기에 드래그하거나 클릭하여 선택하세요</h3>
                        <p>이커머스 및 구독 이벤트 데이터 지원</p>
                        <input type="file" id="fileInput" accept=".csv" hidden>
                    </div>

                    <div class="recent-files">
                        <h4>최근 열어본 파일:</h4>
                        <div id="recentFilesList" class="recent-files-list">
                            <p class="no-recent-files">아직 열어본 파일이 없습니다.</p>
                        </div>
                    </div>
                </div>

                <div class="mapping-section" id="mappingSection" style="display: none;">
                    <h3>컬럼 매핑</h3>
                    <div class="mapping-grid">
                        <div class="mapping-field">
                            <label>타임스탬프 컬럼 *</label>
                            <select id="mapTimestamp" class="mapping-select">
                                <option value="">컬럼 선택...</option>
                            </select>
                        </div>
                        <div class="mapping-field">
                            <label>사용자 ID 컬럼 *</label>
                            <select id="mapUserId" class="mapping-select">
                                <option value="">컬럼 선택...</option>
                            </select>
                        </div>
                        <div class="mapping-field">
                            <label>이벤트 이름 컬럼 *</label>
                            <select id="mapEventName" class="mapping-select">
                                <option value="">컬럼 선택...</option>
                            </select>
                        </div>
                        <div class="mapping-field">
                            <label>세션 ID 컬럼</label>
                            <select id="mapSessionId" class="mapping-select">
                                <option value="">컬럼 선택...</option>
                            </select>
                        </div>
                        <div class="mapping-field">
                            <label>플랫폼 컬럼</label>
                            <select id="mapPlatform" class="mapping-select">
                                <option value="">컬럼 선택...</option>
                            </select>
                        </div>
                        <div class="mapping-field">
                            <label>채널 컬럼</label>
                            <select id="mapChannel" class="mapping-select">
                                <option value="">컬럼 선택...</option>
                            </select>
                        </div>
                    </div>

                    <div class="preview-section">
                        <h4>데이터 미리보기 (처음 10행)</h4>
                        <div class="table-container">
                            <table id="previewTable"></table>
                        </div>
                    </div>

                    <div id="progressContainer" class="progress-container" style="display: none;">
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <div id="progressText" class="progress-text">데이터 처리 중...</div>
                    </div>

                    <button class="btn btn-primary" id="confirmMapping">
                        매핑 확인 및 데이터 처리
                    </button>

                    <!-- Data Quality Summary Panel -->
                    <div id="dataQualitySummary" class="data-quality-summary" style="display: none;">
                        <h3>📊 데이터 품질 요약</h3>
                        <div class="quality-grid">
                            <div class="quality-card">
                                <div class="quality-label">총 행수</div>
                                <div class="quality-value" id="qTotalRows">-</div>
                            </div>
                            <div class="quality-card">
                                <div class="quality-label">유효 행수</div>
                                <div class="quality-value" id="qValidRows">-</div>
                            </div>
                            <div class="quality-card">
                                <div class="quality-label">고유 사용자</div>
                                <div class="quality-value" id="qUniqueUsers">-</div>
                            </div>
                            <div class="quality-card">
                                <div class="quality-label">날짜 범위</div>
                                <div class="quality-value" id="qDateRange">-</div>
                            </div>
                            <div class="quality-card">
                                <div class="quality-label">Platform 결측률</div>
                                <div class="quality-value" id="qPlatformMissing">-</div>
                            </div>
                            <div class="quality-card">
                                <div class="quality-label">Channel 결측률</div>
                                <div class="quality-value" id="qChannelMissing">-</div>
                            </div>
                        </div>
                        <div class="quality-table-section">
                            <h4>Top 10 이벤트</h4>
                            <table id="qTop10Events" class="results-table"></table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen 2: Funnel Builder -->
            <div id="screen-funnel" class="screen">
                <div class="screen-header">
                    <h2>퍼널 분석</h2>
                    <p>전환 퍼널을 구축하고 분석하세요</p>
                </div>

                <div class="funnel-builder">
                    <div class="builder-controls">
                        <h3>퍼널 단계 선택</h3>
                        <div class="template-buttons">
                            <button class="btn btn-secondary" id="loadEcommerceFunnel">
                                🛒 이커머스 퍼널
                            </button>
                            <button class="btn btn-secondary" id="loadSubscriptionFunnel">
                                📱 구독 퍼널
                            </button>
                            <button class="btn btn-secondary lifecycle-funnel-btn" id="loadLifecycleFunnel"
                                style="display: none;">
                                🔄 Lifecycle 퍼널
                            </button>
                        </div>
                        <div id="funnelStepsContainer" class="funnel-steps-container">
                            <!-- 동적으로 퍼널 단계가 추가됩니다 -->
                        </div>
                        <button class="btn btn-primary" id="calculateFunnel">
                            퍼널 계산
                        </button>
                    </div>

                    <div class="funnel-results" id="funnelResults" style="display: none;">
                        <div class="chart-container">
                            <canvas id="funnelChart"></canvas>
                        </div>
                        <div class="funnel-table-container">
                            <table id="funnelTable" class="results-table"></table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen 3: Retention Cohort -->
            <div id="screen-retention" class="screen">
                <div class="screen-header">
                    <h2>리텐션 코호트 분석</h2>
                    <p>시간 경과에 따른 사용자 리텐션을 분석하세요</p>
                </div>

                <div class="retention-controls">
                    <!-- Retention Type Toggle -->
                    <div class="control-group retention-type-toggle" id="retentionTypeToggle" style="display: none;">
                        <label>리텐션 유형</label>
                        <div class="toggle-buttons">
                            <button type="button" class="toggle-btn active" data-type="activity"
                                id="toggleActivityRetention">
                                📊 Activity Retention
                            </button>
                            <button type="button" class="toggle-btn" data-type="paid" id="togglePaidRetention">
                                💳 Paid Retention
                            </button>
                        </div>
                        <small id="retentionTypeDesc">활성 이벤트 기반 리텐션을 계산합니다</small>
                    </div>

                    <div id="activityRetentionControls">
                        <div class="control-group">
                            <label>코호트 이벤트 (첫 이벤트)</label>
                            <select id="cohortEvent" class="control-select">
                                <option value="">이벤트 선택...</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>활성 이벤트 (재방문 이벤트)</label>
                            <select id="activeEvents" class="control-select" multiple size="4">
                                <!-- 옵션이 동적으로 추가됩니다 -->
                            </select>
                            <small>Ctrl/Cmd를 눌러 여러 항목 선택</small>
                        </div>
                    </div>

                    <div id="paidRetentionControls" style="display: none;">
                        <div class="paid-retention-info">
                            <p>💳 <strong>Paid Retention</strong>: 구독 시작일 기준 유료 상태 유지율을 계산합니다.</p>
                            <small>• Cohort = 첫 subscribe 이벤트 날짜</small><br>
                            <small>• Retained = cancel 이벤트 미발생</small>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="calculateRetention">
                        리텐션 계산
                    </button>
                </div>

                <div class="retention-results" id="retentionResults" style="display: none;">
                    <div class="retention-metrics">
                        <div class="metric-card">
                            <div class="metric-label">D1 리텐션</div>
                            <div class="metric-value" id="d1Retention">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">D7 리텐션</div>
                            <div class="metric-value" id="d7Retention">-</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">D14 리텐션</div>
                            <div class="metric-value" id="d14Retention">-</div>
                        </div>
                    </div>

                    <div class="retention-matrix-container">
                        <h3>코호트 매트릭스</h3>
                        <div class="table-container">
                            <table id="retentionMatrix" class="retention-matrix"></table>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3>리텐션 곡선</h3>
                        <canvas id="retentionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Screen 4: Segment Compare -->
            <div id="screen-segment" class="screen">
                <div class="screen-header">
                    <h2>세그먼트 비교</h2>
                    <p>다양한 세그먼트의 성과를 비교하세요</p>
                </div>

                <div class="segment-controls">
                    <div class="control-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="strictOrder"> 엄격 순서 (Strict Order)
                        </label>
                        <small>스텝이 순서대로 발생한 경우만 통과로 인정</small>
                    </div>
                    <div class="control-group">
                        <label>기준 세그먼트</label>
                        <select id="baselineSegment" class="control-select">
                            <option value="all">전체 대비</option>
                            <option value="best">최고 성과 대비</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>플랫폼 세그먼트</label>
                        <div class="checkbox-group" id="platformSegments">
                            <!-- 체크박스가 동적으로 추가됩니다 -->
                        </div>
                    </div>
                    <div class="control-group">
                        <label>채널 세그먼트</label>
                        <div class="checkbox-group" id="channelSegments">
                            <!-- 체크박스가 동적으로 추가됩니다 -->
                        </div>
                    </div>

                    <!-- Subscription Segment Dimensions (shown only for subscription data) -->
                    <div class="control-group subscription-segment-controls" id="subscriptionSegmentControls"
                        style="display: none;">
                        <label>📦 구독 세그먼트 차원</label>
                        <select id="subscriptionDimension" class="control-select">
                            <option value="">구독 차원 선택 (선택사항)...</option>
                            <!-- 동적으로 추가: trial_days, plan, cancel_reason -->
                        </select>
                        <small>구독 데이터 전용 세그먼트 분석</small>
                    </div>

                    <button class="btn btn-primary" id="compareSegments">
                        세그먼트 비교
                    </button>
                </div>

                <div class="segment-results" id="segmentResults" style="display: none;">
                    <div class="chart-container">
                        <canvas id="segmentChart"></canvas>
                    </div>
                    <div class="table-container">
                        <table id="segmentTable" class="results-table"></table>
                    </div>
                </div>
            </div>

            <!-- Screen 5: Insight Cards -->
            <div id="screen-insights" class="screen">
                <div class="screen-header">
                    <h2>자동 인사이트</h2>
                    <p>데이터 기반 인사이트 및 추천</p>

                    <!-- Report Export Buttons -->
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" id="exportReport">
                            📷 리포트 다운로드 (PNG)
                        </button>
                        <button class="btn btn-primary" id="sendEmailReport">
                            📧 이메일로 발송
                        </button>
                        <button class="btn btn-secondary" id="toggleN8nSettings" style="margin-left: auto;">
                            ⚙️ 이메일 설정
                        </button>
                    </div>

                    <!-- n8n Settings Panel (collapsible) -->
                    <div id="n8nSettingsPanel" class="n8n-settings-panel" style="display: none; margin-top: 15px;">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">📧 n8n 이메일 설정</h3>
                        <div class="mapping-grid" style="grid-template-columns: 1fr;">
                            <div class="mapping-field">
                                <label>n8n Webhook URL *</label>
                                <input type="text" id="n8nWebhookUrl" class="mapping-select"
                                    placeholder="https://your-n8n-instance.com/webhook/..." style="width: 100%;">
                                <small style="color: #9ca3af;">n8n 워크플로우의 webhook URL을 입력하세요</small>
                            </div>
                            <div class="mapping-field">
                                <label>수신 이메일 주소 *</label>
                                <input type="text" id="emailRecipients" class="mapping-select"
                                    placeholder="user@example.com, user2@example.com" style="width: 100%;">
                                <small style="color: #9ca3af;">여러 주소는 쉼표(,)로 구분하세요</small>
                            </div>
                            <div class="mapping-field">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="autoSendEmail">
                                    분석 완료 시 자동으로 이메일 발송
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" id="saveN8nSettings">
                                    💾 설정 저장
                                </button>
                                <button class="btn btn-secondary" id="testN8nWebhook">
                                    🔍 연결 테스트
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription KPI Summary (shown only for subscription data) -->
                <div id="subscriptionKPISummary" class="subscription-kpi-section" style="display: none;">
                    <h3>📊 구독 KPI 요약 (Subscription KPI Summary)</h3>

                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">총 사용자</div>
                            <div class="kpi-value" id="kpiUsersTotal">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">구독 전환</div>
                            <div class="kpi-value" id="kpiSubscribeRate">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">유료 사용자</div>
                            <div class="kpi-value" id="kpiPaidUsers">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">총 매출</div>
                            <div class="kpi-value" id="kpiGrossRevenue">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">ARPPU</div>
                            <div class="kpi-value" id="kpiArppu">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">해지율</div>
                            <div class="kpi-value" id="kpiCancelRate">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">결제 실패</div>
                            <div class="kpi-value" id="kpiPaymentFailed">-</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">갱신 성공률</div>
                            <div class="kpi-value" id="kpiRenewRate">-</div>
                        </div>
                    </div>

                    <div class="kpi-details-grid">
                        <!-- Plan Mix -->
                        <div class="kpi-detail-card">
                            <h4>플랜 믹스</h4>
                            <div id="kpiPlanMix" class="plan-mix-bar">
                                <span class="no-data">데이터 없음</span>
                            </div>
                        </div>

                        <!-- Trial Conversion Summary -->
                        <div class="kpi-detail-card" id="trialConversionCard" style="display: none;">
                            <h4>🎯 Trial → Subscribe 전환</h4>
                            <div class="trial-summary">
                                <div class="trial-metric">
                                    <span class="label">전환율</span>
                                    <span class="value" id="trialConversionRate">-</span>
                                </div>
                                <div class="trial-metric">
                                    <span class="label">중간 전환 시간</span>
                                    <span class="value" id="trialMedianTime">-</span>
                                </div>
                            </div>
                            <div class="trial-by-days-table">
                                <table id="trialByDaysTable" class="results-table compact"></table>
                            </div>
                        </div>

                        <!-- Churn Summary -->
                        <div class="kpi-detail-card" id="churnSummaryCard" style="display: none;">
                            <h4>📉 Churn 분석</h4>
                            <div class="churn-summary">
                                <div class="churn-metric">
                                    <span class="label">해지 사용자</span>
                                    <span class="value" id="churnUsers">-</span>
                                </div>
                                <div class="churn-metric">
                                    <span class="label">중간 해지 기간</span>
                                    <span class="value" id="churnMedianDays">-</span>
                                </div>
                            </div>
                            <h5>해지 사유 Top 3</h5>
                            <div id="churnReasonsList" class="churn-reasons">
                                <span class="no-data">데이터 없음</span>
                            </div>
                        </div>

                        <!-- Paid Retention Summary -->
                        <div class="kpi-detail-card" id="paidRetentionCard" style="display: none;">
                            <h4>🔒 Paid Retention</h4>
                            <div class="paid-retention-summary">
                                <div class="retention-metric">
                                    <span class="label">D7</span>
                                    <span class="value" id="paidRetD7">-</span>
                                </div>
                                <div class="retention-metric">
                                    <span class="label">D14</span>
                                    <span class="value" id="paidRetD14">-</span>
                                </div>
                                <div class="retention-metric">
                                    <span class="label">D30</span>
                                    <span class="value" id="paidRetD30">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="insightsContainer" class="insights-grid">
                    <div class="insight-placeholder">
                        <p>퍼널 분석 및 리텐션 코호트 화면에서 데이터를 처리하여 인사이트를 생성하세요.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Application Scripts -->
    <script src="pdf_font_noto_sans_kr.js"></script>
    <script src="app.js"></script>
    <script src="charts.js"></script>
</body>

</html>